// Copyright (C) 2020-2021 Intel Corporation
// SPDX-License-Identifier: Apache-2.0

#include <gtest/gtest.h>

#include <memory>
#include <random>
#include <vector>

#include "hexl/experimental/seal/ckks-switch-key.hpp"
#include "hexl/logging/logging.hpp"
#include "hexl/number-theory/number-theory.hpp"
#include "test-util.hpp"

namespace intel {
namespace hexl {

TEST(CkksSwitchKey, small) {
  std::vector<std::vector<uint64_t>> key_vector{
      {31369078234928549,   167410544543601533,  30295063465117864,
       1029113708974659001, 350455048150478228,  1069609725127969255,
       1095239690300936370, 559542970999798226,  1113118014604834368,
       80445551769419656,   545362596095709695,  485637139473951465,
       116020618343478474,  801934249052842378,  970219816143916801,
       1058452012721328932, 870915869136302447,  402386581348438533,
       1065588400627367011, 157588820834882581,  146068553477328742,
       1042667453166545590, 595073719978649885,  823077372512526233,
       995530245730222941,  812007683370049732,  337703844157246839,
       808682978399161429,  913647413305744800,  63500453384227259,
       975239036429266878,  250079223903275949,  896761180441348710,
       439128758341811319,  772988782437626043,  909591374183886736,
       351605775904614399,  245669369252826903,  99838041204989119,
       997636640184350688,  1029368738428779874, 806642759538225504,
       71973668581320190,   722420941300790331,  682444628450766747,
       1006658105772622187, 392185171627884168,  279897649381283504,
       607126579845444596,  523677329583686245,  876689480851459405,
       870443905693074434,  346704991372895838,  391139030755466109,
       769939737600349745,  1114191753334760295, 437508080522107209,
       37088441641534144,   377795713357953884,  278835516193096942,
       770965498199333161,  416821214609044034,  636181616064335660,
       257162050628395041,  926326292454275307,  1143847307170567958,
       1023880313549978602, 335820784739027926,  837583550898488850,
       714014692066771197,  663272924403084028,  894944803742088035,
       109914415847555142,  791292420202543959,  348244536989110469,
       688053345118295652,  335936743801514204,  732834909716799754,
       207609272137584237,  271671532013193649,  407722526351389064,
       82911897751260137,   393611688972488922,  376878436971945487,
       846472159350520059,  337000750558850773,  268545460951708300,
       459013000042831212,  691036738168843143,  3555741998349423,
       349347154001009930,  560381288282565540,  759808009117113298,
       522637499639226850,  1126179821426876151, 1091630265319001783},
      {89873054755123330,   326616096109446307,  520343486925087077,
       653174129747721535,  1119250873759085069, 708940711689947363,
       201586746120355067,  983619136387357185,  737478992366508820,
       838369153278707906,  451286807005268211,  564041546714935251,
       768108857663159231,  416015029409745206,  539180391289417127,
       586340814781173694,  517957769458336870,  516874973338334751,
       801043703806519925,  927409302171519785,  814111599836437487,
       810502477294356609,  810983291860630293,  249148390683103435,
       462537862019276347,  1114751529344521012, 467191879477073117,
       975915555577328102,  1041205056817057596, 685177182464908962,
       149718950486724175,  1068149629731891456, 896761180441348710,
       439128758341811319,  772988782437626043,  909591374183886736,
       351605775904614399,  245669369252826903,  99838041204989119,
       997636640184350688,  1029368738428779874, 806642759538225504,
       71973668581320190,   722420941300790331,  682444628450766747,
       1006658105772622187, 392185171627884168,  279897649381283504,
       607126579845444596,  523677329583686245,  876689480851459405,
       870443905693074434,  346704991372895838,  391139030755466109,
       769939737600349745,  1114191753334760295, 437508080522107209,
       37088441641534144,   377795713357953884,  278835516193096942,
       770965498199333161,  416821214609044034,  636181616064335660,
       257162050628395041,  926326292454275307,  1143847307170567958,
       1023880313549978602, 335820784739027926,  837583550898488850,
       714014692066771197,  663272924403084028,  894944803742088035,
       109914415847555142,  791292420202543959,  348244536989110469,
       688053345118295652,  335936743801514204,  732834909716799754,
       207609272137584237,  271671532013193649,  407722526351389064,
       82911897751260137,   393611688972488922,  376878436971945487,
       846472159350520059,  337000750558850773,  268545460951708300,
       459013000042831212,  691036738168843143,  3555741998349423,
       349347154001009930,  560381288282565540,  759808009117113298,
       522637499639226850,  1126179821426876151, 1091630265319001783}};

  size_t coeff_count = 16;
  std::vector<uint64_t> moduli{1152921504606844417, 1152921504606844513,
                               1152921504606845473};

  // size decomp_modulus_size
  std::vector<uint64_t> modswitch_factors{1047018677005647534,
                                          1036428394245527932};
  size_t decomp_modulus_size = 2;
  size_t key_modulus_size = 3;
  size_t rns_modulus_size = 3;
  size_t key_component_count = 2;

  std::vector<const uint64_t*> hexl_key_vectors;
  for (auto& each_key : key_vector) {
    hexl_key_vectors.push_back(&each_key.data()[0]);
  }

  std::vector<uint64_t> input{
      309939064110586901,  451312085004349512,  882903116694970497,
      1093749375736930196, 411821859017025404,  1121873370851731682,
      670590992712042547,  872840509717262120,  954337535848042283,
      718278395972892277,  1111208627088419160, 824743622506129167,
      1001558143368137981, 96920090003600788,   949961333638731679,
      923858185179999823,  1113848237884615331, 959412567469145467,
      859210277205990667,  822430581217081861,  480267076233076947,
      225243686971827410,  730689801764347033,  528298360406900389,
      138501526699581979,  1092967882971961295, 580905959433010662,
      351821126548194417,  25169770702816533,   269338260100095445,
      989908645560307191,  1083232529988885462, 199743077891248337,
      45350898252201920,   520413747874700379,  798236191365674310,
      306057106308510612,  915485980916714257,  173706584180453182,
      818593070995232781,  439133138449531358,  703831179776447716,
      428342677657435367,  76119365963542295,   746684297130764143,
      879503424958138925,  913944067499620531,  883572924636256248,
      128708740540900462,  1089491495533625982, 448517149883349853,
      1052824173420271503, 63620226327680354,   551552858385324721,
      450255932106529562,  208762778846281448,  321384903649655207,
      410032640763252152,  244794820679959515,  61689117770931594,
      158745490550837326,  767620575722239071,  937492088261647801,
      216611853169055339,  754456001494305689,  1103969306386992224,
      778447417301411654,  77890077030636524,   562272518474416451,
      617759205676632763,  137333390234583498,  847271379908091473,
      843204278942158126,  338984182620486881,  358287317722628763,
      893685844072834427,  371252050879235662,  466759492639294297,
      169735358743135221,  1025895978930331858, 1119837632754806494,
      102495632867771090,  570165268757777964,  890385541314698278,
      396930254673931570,  1131044024754944332, 761757922665814307,
      660572216313672066,  882715203237352097,  204696921447202932,
      8192237299084775,    409326672106986276,  871859211375214104,
      683969770428749805,  1007557589887202473, 1058613598685494981};

  std::vector<uint64_t> t_target_iter_ptr{
      754456001494305689,  1103969306386992224, 778447417301411654,
      77890077030636524,   562272518474416451,  617759205676632763,
      137333390234583498,  847271379908091473,  843204278942158126,
      338984182620486881,  358287317722628763,  893685844072834427,
      371252050879235662,  466759492639294297,  169735358743135221,
      1025895978930331858, 1119837632754806494, 102495632867771090,
      570165268757777964,  890385541314698278,  396930254673931570,
      1131044024754944332, 761757922665814307,  660572216313672066,
      882715203237352097,  204696921447202932,  8192237299084775,
      409326672106986276,  871859211375214104,  683969770428749805,
      1007557589887202473, 1058613598685494981};

  CkksSwitchKey(input.data(), t_target_iter_ptr.data(), coeff_count,
                decomp_modulus_size, key_modulus_size, rns_modulus_size,
                key_component_count, moduli.data(), hexl_key_vectors.data(),
                modswitch_factors.data());

  std::vector<uint64_t> expected_output{
      89296029533050855,   567993976793839274,  697003759686378746,
      954200861828558681,  689059820602871502,  584916558515910741,
      1113016444755385790, 516459831127873004,  853854391295677105,
      803745488422719022,  348933677108109560,  1042041991890481715,
      249754100961496944,  905908129921593063,  673977797089635231,
      170767802849348432,  304088977430009609,  445651998168994950,
      312087501328798066,  639799581779694831,  454743895520407562,
      1058792827229853104, 75780057043342395,   584325937127197146,
      644814876255694377,  523058110419679539,  418718157245016964,
      628771060933657117,  365105062057622652,  689317920107110551,
      1122739864436715515, 927797597840385390,  604718288130669178,
      35660497432980498,   622371763548914435,  970457320949190720,
      738770907185748198,  657824524642799580,  943718625650286270,
      753153158855748514,  37184128967339212,   873996122134404746,
      226555779311502898,  562475499750542681,  752409970800036216,
      708821234853973459,  809614432717950315,  1115565253826640226,
      221082875181656791,  956926195938203506,  942336604598200681,
      49168939851467655,   202063037837451976,  827436047316651204,
      223851251475980734,  769027623505616893,  128773783233783021,
      827862733453328407,  752577586897001479,  1034817794012654154,
      877127397759360655,  1083996636730543517, 745005168217272582,
      384338002660892880,  754456001494305689,  1103969306386992224,
      778447417301411654,  77890077030636524,   562272518474416451,
      617759205676632763,  137333390234583498,  847271379908091473,
      843204278942158126,  338984182620486881,  358287317722628763,
      893685844072834427,  371252050879235662,  466759492639294297,
      169735358743135221,  1025895978930331858, 1119837632754806494,
      102495632867771090,  570165268757777964,  890385541314698278,
      396930254673931570,  1131044024754944332, 761757922665814307,
      660572216313672066,  882715203237352097,  204696921447202932,
      8192237299084775,    409326672106986276,  871859211375214104,
      683969770428749805,  1007557589887202473, 1058613598685494981};

  AssertEqual(input, expected_output);
}

TEST(CkksSwitchKey, big) {
  std::vector<std::vector<uint64_t>> key_vector{
      {59295508887731423,   215823459102569579,  76348767210646917,
       1009543524842809072, 413045661992917228,  866059551607348072,
       852027121638023837,  884537555639362701,  68311224860930607,
       483563470560233097,  571097384970116771,  137987568213522894,
       33337527861988821,   435472389940378386,  570497657535400221,
       414587270664876572,  493349299376057266,  491558416350192839,
       64397833438723918,   479055883910885144,  80319991336027149,
       989024244866874309,  783784207910926785,  523615013686130518,
       325801610922238937,  565471369450668786,  976581384843568456,
       541992338712118402,  295900641592843374,  539562111887681509,
       759209193251150480,  710474247789277586,  25126771905956669,
       1145939483078863256, 25097706156332525,   261041847357231955,
       846351153338069312,  677169235514371558,  147061509756007891,
       687388465305079826,  635692402165608267,  459467854314270771,
       45132778501432765,   429414116778965662,  725222428240808291,
       579057001528850541,  782850783822748910,  656962227602268421,
       107847082092280217,  962132296438530192,  402986384401314352,
       1143818127096760841, 1013063510430556694, 1029070242887301237,
       693650453587459785,  951430071016850141,  958998007355115462,
       1033019244117140477, 589958632648539170,  599732242162291502,
       832617169484279585,  966872231607158113,  840647742819893287,
       1098749788828588214, 954081821126191407,  129660955743545415,
       840105554324101505,  121362461069614466,  1121550984970243078,
       699116338482079449,  317584722573168550,  1100142293836605709,
       1057095204403225148, 1134223717173746513, 209334238315749259,
       442433223048132334,  773249371845362269,  243447951147691901,
       861949766303559281,  370899381777395214,  84302601583647601,
       603055015426622816,  465093636086721522,  798261496410843105,
       1032579687145050070, 428997556395330283,  589042985416507455,
       1085338665881516611, 858102256591866188,  118477399447618437,
       619303542097468493,  1006486044274031189, 288810572674305054,
       1151570456804164155, 971022157068753538,  795815290193138583,
       504723964293614334,  711695670848467098,  859990154167796080,
       739431282988888357,  673497890286006274,  1146179477690686381,
       253401449086712106,  121066198847313012,  229862394169046421,
       431342601084223678,  841161476620572692,  587728210978696651,
       986821873770531040,  727883711078590261,  951458688360751810,
       1023628329035062759, 1074741792704386359, 737588367204064818,
       43760263774397546,   1078736177345028555, 736214866008795077,
       942081465732623184,  235220178323196298,  673309606707523096,
       637896774863808266,  722395053095926513,  1102853201885576707,
       299958161410489290,  807749232991612301,  286997244473158315,
       609143407733265655,  655523904751348333,  88522703112158972,
       1058669093857755979, 78783302919357679,   218051712631752486,
       572357742370808854,  251169544132076026,  982925230384412608,
       560316387099157926,  476698048540675505,  754510709428160620,
       622695957517451497,  1076178493147573031, 745097271681566095,
       411923110337991799,  497999007499388450,  246589095379467464,
       200253807278059701,  1025038743250862970, 296450781990769460,
       620351092628688404,  689066231492389208,  1092208359290807439,
       1058618404115413848, 183977093838661650,  420710149686076066,
       842387545831106678,  1137663473963135904, 798000419555892542,
       1003967094172116796, 895236741588583210,  1149938497802003264,
       762599219119861829,  564503810575419537,  528884421938012389,
       266036389614829709,  29173484232060199,   907182382399319835,
       278325143973471863,  1116458027547654260, 21871640993368389,
       627948145360918776,  1125286488044898970, 1034639324682167607,
       458566522106120393,  449919487427293488,  940686239658724396,
       958630891201254073,  982949715864893397,  720497057990080361,
       349473676991156440,  723602453685176802,  901994258075212942,
       471039238566686542,  113072417185624384,  605723373469693898,
       104911617091772330,  254778656353831495,  1124020627526039802,
       111548009580852704,  792766014750490764,  224098508477932127,
       684117665709819037,  348872849674684969,  81487725244808221,
       607126579845467892,  523677329583706213,  876689480851462733,
       870443905693076098,  346704991372910814,  391139030755481085,
       769939737600363057,  1114191753334770279, 437508080522110537,
       37088441641552448,   377795713357978844,  278835516193096942,
       770965498199356457,  416821214609055682,  636181616064352300,
       257162050628411681,  926326292454299947,  1143847307170592598,
       1023880313549999722, 335820784739036726,  837583550898511730,
       714014692066772957,  663272924403099868,  894944803742114435,
       109914415847578022,  791292420202547479,  348244536989121029,
       688053345118311492,  335936743801526524,  732834909716805034,
       207609272137600077,  271671532013211249,  407722526351427144,
       82911897751300937,   393611688972524282,  376878436971983567,
       846472159350547259,  337000750558872533,  268545460951732780,
       459013000042847532,  691036738168854023,  3555741998390223,
       349347154001020810,  560381288282600900,  759808009117135058,
       522637499639248610,  1126179821426881591, 1091630265319042583,
       1063098871926411256, 454593495104358100,  170333457703560765,
       981925870715106856,  333345232076500888,  172843330427655797,
       227334762697789473,  721811512626062706,  1011968867039299234,
       512305984532596635,  782003959678470145,  206647312521057094,
       228176844327385384,  735606548042488442,  324904893949982,
       833004728998784866,  609197979554106765,  1135041622153817785,
       558881460987881753,  1023652588852818100, 1015783799347854491,
       960005439264273449,  618193569124154876,  340837166447446935,
       669855705653524211,  755608464269534895,  789127878460833033,
       956199449356586382,  574551184487501342,  1018366734315872040,
       308107915090692831,  334115385187459755,  480652544379227729,
       95178342829187473,   244921169529764940,  43123266704653085,
       882082201697667265,  896486836601534866,  66542142120364564,
       222817236902915133,  450565459743841558,  804699514091184611,
       625019590107921806,  638422521504147285,  1032165215113470932,
       80661908796854105,   487267646821938505,  1010793088300598796,
       97900089344926842,   772440906434777890,  95321291164336135,
       571194503952820075,  841971596762970680,  576402303856707789,
       146275217498984878,  858690298933055508,  1026320880790714202,
       832587396138280420,  1027281140605041888, 783532124683166531,
       1777957467333177,    98273344832064823,   69502200361289017,
       113157913736909768,  440034429817388894,  330246331513134231,
       796367476782711994,  965634388106463907,  328443674395940979,
       241126285941727068,  1034248343475632090, 549814678979043066,
       1117620626004761298, 745795433871771881,  1071755953418888835,
       809230052102395919,  970804671152288783,  902058287433993042,
       971506062488076817,  1134203746847649812, 141740100525881243,
       854242991618640973,  978767804999860561,  57252187712675993,
       155947673709658955,  242584838419989684,  617155609909899742,
       65984402224307813,   1096738086509677010, 1123055315126790292,
       487714520927818543,  104543721026494269,  675000347726643770,
       166298468063408346,  672746126220414859,  571885508465387630,
       592701089088026359,  126786463310015652,  6893598764371651,
       936932221217742818,  1008875521789474728, 1000472042700500339,
       802068126904845964,  495833816404368064,  1093370978752100109,
       253889199123108067,  778119439203532132,  373944990325920231,
       1059417152633083736, 521456407318524716,  593080991645155230,
       655521673196901501,  652365502477517886,  346599543263003920,
       427107308655848750,  880233019595101524,  764419146094415735,
       262727622897271657,  325909627605780327,  480077316749803614,
       482051130331804168,  577308905543629399,  472625417029434780,
       161031655888478690,  173190088659737253,  15572597450336063,
       1137441076646781690, 577040596661810599,  731007934227921973,
       797509849319184249,  767324821052745237,  448794493615409552,
       284130345323441754,  247568572733377826,  1146532219147450898,
       77729749332344129,   892182616764571874,  777967377781276372,
       176084443664831841,  500247072782192672,  581134876305663493,
       415909248254390925,  332450814053594904,  427770816962114486,
       728859510398919727,  773352707019773225,  216974263758796995,
       243646792641416740,  398300559892323144,  349884916328283206,
       666901461322082526,  825063742699843531,  735332286273732885,
       190017546452597920,  974618648308098336,  58591792063308224,
       142498585323255457,  833212663592320644,  540868084821238731,
       1037339614227289924, 300782301694399679,  318395663127495665,
       496399282000165718,  152874789124035885,  162223806242877768,
       283858297747173005,  122910630849452873,  1117944124966762671,
       1033781209606551694, 556309325864413152,  156467816310633742,
       404895955485989718,  194794408785268815,  800160827957627679,
       370120522197935651,  339450565446771116,  80017871536806872,
       359530369910702018,  807037231155174519,  704792023927171837,
       1062708183403865656, 730770120918760139,  267394897601116908,
       102376373652433447,  250161025995648830,  1067839248490695095,
       347888662677683790,  896682879919818952,  476696797549093104,
       113335385886842718,  696786004142534587,  458853180765731017,
       475514991891760126,  44360586937649544,   342642028533686013,
       540140477916063578,  451235745630534999,  440806751369091517,
       18662126583109407,   1001652598846805760, 1066208231642184040,
       868785660331909558,  457492808883376516,  931052627354486691,
       747568031266424233,  1018974270799331960, 546205990123543568,
       705432025200278721,  83784802717288791,   418691265932169221,
       829844830618150148,  1109451666932760593, 701288451166880345,
       1086397565690700284, 826753327092994396,  188398893052941480,
       21741614329154105,   458531929145169475,  568815139012948836,
       703959540098845869,  1027876638614627075, 487016759799545165,
       1083417285484632088, 421599801264557726,  339484468438185696,
       692012767678033250,  340417927174239796,  295399475136818481,
       812535992368240937,  189536135567564630,  1094793671773342956,
       986389716997972129,  358122864067958006,  574993094055535816,
       900026864833224193,  1040212698638335719, 182351187439263314,
       331724357734814254,  475489533698968211,  626095332683823541,
       242816516166099298,  839317480787448000,  1043239901527006802,
       107003058688158240,  782228417639105896,  821364714767362436,
       430635966060957950,  818287563395146205,  703187191490904454,
       194830151895178555,  1127813282672392588, 471302432859159280,
       960827641974259078,  526673450253396631,  790363684670217418,
       702393215890915022,  1008822882252239479, 166011755480587907,
       179705628862698837,  392879327679005004,  336792895857275279,
       79318366995802677,   499913213431033485,  137995949863135041,
       981002728568884155,  578532662456948555,  483228289915383692,
       113459356291461976,  779567566115974805,  922343200385277250,
       558547433296546343,  1057292876093088885, 88522703112158972,
       1058669093857755979, 78783302919357679,   218051712631752486,
       572357742370808854,  251169544132076026,  982925230384412608,
       560316387099157926,  476698048540675505,  754510709428160620,
       622695957517451497,  1076178493147573031, 745097271681566095,
       411923110337991799,  497999007499388450,  246589095379467464,
       200253807278059701,  1025038743250862970, 296450781990769460,
       620351092628688404,  689066231492389208,  1092208359290807439,
       1058618404115413848, 183977093838661650,  420710149686076066,
       842387545831106678,  1137663473963135904, 798000419555892542,
       1003967094172116796, 895236741588583210,  1149938497802003264,
       762599219119861829,  564503810575419537,  528884421938012389,
       266036389614829709,  29173484232060199,   907182382399319835,
       278325143973471863,  1116458027547654260, 21871640993368389,
       627948145360918776,  1125286488044898970, 1034639324682167607,
       458566522106120393,  449919487427293488,  940686239658724396,
       958630891201254073,  982949715864893397,  720497057990080361,
       349473676991156440,  723602453685176802,  901994258075212942,
       471039238566686542,  113072417185624384,  605723373469693898,
       104911617091772330,  254778656353831495,  1124020627526039802,
       111548009580852704,  792766014750490764,  224098508477932127,
       684117665709819037,  348872849674684969,  81487725244808221},
      {728859510398919727,  773352707019773225,  216974263758796995,
       243646792641416740,  398300559892323144,  349884916328283206,
       666901461322082526,  825063742699843531,  735332286273732885,
       190017546452597920,  974618648308098336,  58591792063308224,
       142498585323255457,  833212663592320644,  540868084821238731,
       1037339614227289924, 300782301694399679,  318395663127495665,
       496399282000165718,  152874789124035885,  162223806242877768,
       283858297747173005,  122910630849452873,  1117944124966762671,
       1033781209606551694, 556309325864413152,  156467816310633742,
       404895955485989718,  194794408785268815,  800160827957627679,
       370120522197935651,  339450565446771116,  80017871536806872,
       359530369910702018,  807037231155174519,  704792023927171837,
       1062708183403865656, 730770120918760139,  267394897601116908,
       102376373652433447,  250161025995648830,  1067839248490695095,
       347888662677683790,  896682879919818952,  476696797549093104,
       113335385886842718,  696786004142534587,  458853180765731017,
       475514991891760126,  44360586937649544,   342642028533686013,
       540140477916063578,  451235745630534999,  440806751369091517,
       18662126583109407,   1001652598846805760, 1066208231642184040,
       868785660331909558,  457492808883376516,  931052627354486691,
       747568031266424233,  1018974270799331960, 546205990123543568,
       705432025200278721,  83784802717288791,   418691265932169221,
       829844830618150148,  1109451666932760593, 701288451166880345,
       1086397565690700284, 826753327092994396,  188398893052941480,
       21741614329154105,   458531929145169475,  568815139012948836,
       703959540098845869,  1027876638614627075, 487016759799545165,
       1083417285484632088, 421599801264557726,  339484468438185696,
       692012767678033250,  340417927174239796,  295399475136818481,
       812535992368240937,  189536135567564630,  1094793671773342956,
       986389716997972129,  358122864067958006,  574993094055535816,
       900026864833224193,  1040212698638335719, 182351187439263314,
       331724357734814254,  475489533698968211,  626095332683823541,
       242816516166099298,  839317480787448000,  1043239901527006802,
       107003058688158240,  782228417639105896,  821364714767362436,
       430635966060957950,  818287563395146205,  703187191490904454,
       194830151895178555,  1127813282672392588, 471302432859159280,
       960827641974259078,  526673450253396631,  790363684670217418,
       702393215890915022,  1008822882252239479, 166011755480587907,
       179705628862698837,  392879327679005004,  336792895857275279,
       79318366995802677,   499913213431033485,  137995949863135041,
       981002728568884155,  578532662456948555,  483228289915383692,
       113459356291461976,  779567566115974805,  922343200385277250,
       558547433296546343,  1057292876093088885, 88522703112158972,
       1058669093857755979, 78783302919357679,   218051712631752486,
       572357742370808854,  251169544132076026,  982925230384412608,
       560316387099157926,  476698048540675505,  754510709428160620,
       622695957517451497,  1076178493147573031, 745097271681566095,
       411923110337991799,  497999007499388450,  246589095379467464,
       200253807278059701,  1025038743250862970, 296450781990769460,
       620351092628688404,  689066231492389208,  1092208359290807439,
       1058618404115413848, 183977093838661650,  420710149686076066,
       842387545831106678,  1137663473963135904, 798000419555892542,
       1003967094172116796, 895236741588583210,  1149938497802003264,
       762599219119861829,  564503810575419537,  528884421938012389,
       266036389614829709,  29173484232060199,   907182382399319835,
       278325143973471863,  1116458027547654260, 21871640993368389,
       627948145360918776,  1125286488044898970, 1034639324682167607,
       458566522106120393,  449919487427293488,  940686239658724396,
       958630891201254073,  982949715864893397,  720497057990080361,
       349473676991156440,  723602453685176802,  901994258075212942,
       471039238566686542,  113072417185624384,  605723373469693898,
       104911617091772330,  254778656353831495,  1124020627526039802,
       111548009580852704,  792766014750490764,  224098508477932127,
       684117665709819037,  348872849674684969,  81487725244808221,
       607126579845467892,  523677329583706213,  876689480851462733,
       870443905693076098,  346704991372910814,  391139030755481085,
       769939737600363057,  1114191753334770279, 437508080522110537,
       37088441641552448,   377795713357978844,  278835516193096942,
       770965498199356457,  416821214609055682,  636181616064352300,
       257162050628411681,  926326292454299947,  1143847307170592598,
       1023880313549999722, 335820784739036726,  837583550898511730,
       714014692066772957,  663272924403099868,  894944803742114435,
       109914415847578022,  791292420202547479,  348244536989121029,
       688053345118311492,  335936743801526524,  732834909716805034,
       207609272137600077,  271671532013211249,  407722526351427144,
       82911897751300937,   393611688972524282,  376878436971983567,
       846472159350547259,  337000750558872533,  268545460951732780,
       459013000042847532,  691036738168854023,  3555741998390223,
       349347154001020810,  560381288282600900,  759808009117135058,
       522637499639248610,  1126179821426881591, 1091630265319042583,
       1063098871926411256, 454593495104358100,  170333457703560765,
       981925870715106856,  333345232076500888,  172843330427655797,
       227334762697789473,  721811512626062706,  1011968867039299234,
       512305984532596635,  782003959678470145,  206647312521057094,
       228176844327385384,  735606548042488442,  324904893949982,
       833004728998784866,  609197979554106765,  1135041622153817785,
       558881460987881753,  1023652588852818100, 1015783799347854491,
       960005439264273449,  618193569124154876,  340837166447446935,
       669855705653524211,  755608464269534895,  789127878460833033,
       956199449356586382,  574551184487501342,  1018366734315872040,
       308107915090692831,  334115385187459755,  480652544379227729,
       95178342829187473,   244921169529764940,  43123266704653085,
       882082201697667265,  896486836601534866,  66542142120364564,
       222817236902915133,  450565459743841558,  804699514091184611,
       625019590107921806,  638422521504147285,  1032165215113470932,
       80661908796854105,   487267646821938505,  1010793088300598796,
       97900089344926842,   772440906434777890,  95321291164336135,
       571194503952820075,  841971596762970680,  576402303856707789,
       146275217498984878,  858690298933055508,  1026320880790714202,
       832587396138280420,  1027281140605041888, 783532124683166531,
       1777957467333177,    98273344832064823,   69502200361289017,
       113157913736909768,  440034429817388894,  330246331513134231,
       796367476782711994,  965634388106463907,  328443674395940979,
       241126285941727068,  1034248343475632090, 549814678979043066,
       1117620626004761298, 745795433871771881,  1071755953418888835,
       809230052102395919,  970804671152288783,  902058287433993042,
       971506062488076817,  1134203746847649812, 141740100525881243,
       854242991618640973,  978767804999860561,  57252187712675993,
       155947673709658955,  242584838419989684,  617155609909899742,
       65984402224307813,   1096738086509677010, 1123055315126790292,
       487714520927818543,  104543721026494269,  675000347726643770,
       166298468063408346,  672746126220414859,  571885508465387630,
       592701089088026359,  126786463310015652,  6893598764371651,
       936932221217742818,  1008875521789474728, 1000472042700500339,
       802068126904845964,  495833816404368064,  1093370978752100109,
       253889199123108067,  778119439203532132,  373944990325920231,
       1059417152633083736, 521456407318524716,  593080991645155230,
       655521673196901501,  652365502477517886,  346599543263003920,
       427107308655848750,  880233019595101524,  764419146094415735,
       262727622897271657,  325909627605780327,  480077316749803614,
       482051130331804168,  577308905543629399,  472625417029434780,
       161031655888478690,  173190088659737253,  15572597450336063,
       1137441076646781690, 577040596661810599,  731007934227921973,
       797509849319184249,  767324821052745237,  448794493615409552,
       284130345323441754,  247568572733377826,  1146532219147450898,
       77729749332344129,   892182616764571874,  777967377781276372,
       176084443664831841,  500247072782192672,  581134876305663493,
       415909248254390925,  332450814053594904,  427770816962114486}};

  std::vector<const uint64_t*> hexl_key_vectors;

  std::vector<uint64_t> t_target_iter_ptr{
      268718072712056857,  799679295999432096,  877737065347036661,
      261343760911993284,  1096870474980790540, 541279401623228829,
      1032897368577104466, 1132999443019068380, 1117844546353328914,
      805720085973977919,  848068263953299875,  708404131463553206,
      1080798314870364301, 910464010117257019,  820975159710082242,
      114244672434791072,  1004917575860579148, 574544632321034842,
      487555282935243041,  32045219113645017,   822122735387641296,
      603495590060892986,  1101232770689274521, 253602686427681312,
      535125416404396885,  450698241685713040,  1022544729874983339,
      450918803597266311,  285668543154220419,  1083631556585100464,
      741150882145335127,  122776688463289959,  68518555797754421,
      610264886124823881,  927366314245075309,  129667856526870801,
      180410988496533532,  991440439722571681,  495776282696262499,
      851109648641560651,  571665913696215992,  1136035493147048861,
      1042272061730279040, 1140597091108701170, 904383134456157801,
      967648097276230820,  926785835601841211,  573837565999821153,
      758655584267614695,  335742953150641522,  1143215184036239705,
      399784986585544111,  362859042491043042,  408220006591973856,
      334743592113172179,  360163356513050181,  519300207792721670,
      22120809146240716,   157057812806148939,  65731902815540253,
      895585302446409838,  1006301995126111827, 960344288229175006,
      167425840771953112,  1019050046265279676, 803905160578991090,
      196981285292612029,  1027525581532676909, 783291142667402737,
      637591777129905300,  203509228896030097,  578369585867051932,
      306175142543180711,  527183649257350712,  298761819878559596,
      770846512803661264,  456660836810349853,  534428662183216239,
      842111733276304247,  394769634241014284,  112856199016109603,
      971265908897590383,  1045819799405208629, 31944520965303968,
      828996107407303046,  362031915569912650,  132638227145314718,
      145649537602835082,  156981263900713171,  892055339030202808,
      993226899348433697,  940395746528998598,  354273626972518039,
      123398838071098824,  447903169169363376,  177001922343950696,
      1150818510475407851, 1060217167453021511, 384262093677458195,
      991501542981961173,  783221638087608765,  835284781023452965,
      238157863849845879,  862462096493953887,  601492467627234280,
      90323127617632951,   154603958289225232,  254393792228213366,
      719714960680456622,  664324492910031671,  466925225921152695,
      1019655930490050942, 786175642054411614,  238319049373971569,
      727911002276540136,  353118372779384785,  389460938567325765,
      906417873575119877,  103263339379697729,  430069115484512019,
      1096594234986668915, 119820604094917308,  603640004505724285,
      425691191666798134,  519130511855215514,  133480117859470228,
      330568291141492744,  192941371839836959};

  for (auto& each_key : key_vector) {
    hexl_key_vectors.push_back(&each_key.data()[0]);
  }

  size_t coeff_count = 64;
  std::vector<uint64_t> moduli{1152921504606842753, 1152921504606844289,
                               1152921504606844417};

  // size decomp_modulus_size
  std::vector<uint64_t> modswitch_factors{354052216859433081,
                                          1143914305352103318};
  size_t decomp_modulus_size = 2;
  size_t key_modulus_size = 3;
  size_t rns_modulus_size = 3;
  size_t key_component_count = 2;

  // size_t output_size = 384;  // TODO(fboemer) check

  std::vector<uint64_t> input{
      626793183889648309,  635881195412409020,  271645475607335084,
      774128026537951851,  82019065316976135,   22215723010060333,
      45121328313310232,   727544498536148635,  265857805103016335,
      1077829278381364386, 42042615271514699,   84338361916287983,
      120457452232861628,  38769242342928938,   954421036870361207,
      551026843885473347,  753125705966865175,  946158305480686512,
      8167732276314880,    268687693659594968,  1081142291533926571,
      978524741829786832,  1122650846112198902, 793283519023228098,
      420467393922616944,  1092609297625866101, 261005764004789224,
      1002111945631576290, 536028263068458538,  112323006384046004,
      317109044624329812,  536700494043905586,  782744396030547249,
      1105981458406025030, 1151425868918885452, 203712884761646980,
      145477554011919672,  117819505800027490,  712667892989017502,
      218134025175470525,  233152070645376854,  555121935099866684,
      38624827423497124,   74394045309641241,   697995007686450565,
      433549566868690254,  221295376560043738,  699059508414422051,
      780806036550131888,  372602989105624699,  908673514039229818,
      196013402634575229,  612102603423496886,  463077696849653993,
      247206074976761131,  766427152641950415,  578599917504732486,
      454613764369832254,  647997188402777776,  26572595941601832,
      788394899744774362,  974484030416745191,  172195220213991418,
      1110074607157812320, 41104710369038556,   712750647395772309,
      860751362161486186,  687504949227085989,  876073549187047805,
      612523062127343016,  570934424226111599,  1130522469932681235,
      770506803763493875,  1045431318248772282, 1047820021435633919,
      985711105557125141,  858380926890011588,  430752710756041942,
      1053334302971912698, 1152515913882918496, 146453376958510721,
      507719185383835955,  185521812872112758,  473602493007766145,
      337631169376212170,  968339534677456796,  542837738106619011,
      176914495716953146,  886316442438281675,  911538969820549032,
      267325629567209618,  788686203115461943,  15884626072095347,
      251320141828419821,  700727449079893013,  708046497451854013,
      506811616749901917,  220251913392474032,  175285945820044796,
      370370479792135503,  865933412395349344,  958513810970819853,
      43967994146176904,   73925560721850454,   1063567919093322126,
      474354097970357179,  1132618692365257323, 91219125340273433,
      406563349562300929,  839918466701423738,  208397287673199813,
      1001520791132253742, 678615453813039946,  24912268568809197,
      471827453667828573,  400174669697524178,  54094250677747723,
      411180226948806659,  872143741695246088,  347048024692189067,
      532321805205118490,  831603651115931636,  1025531422400933930,
      404564556481787962,  762017921360394150,  212907896613204907,
      1123839302068425112, 589683021446981685,  186665521449637195,
      180620997202862890,  356850965167816514,  811261513280218959,
      117089210978030446,  896217189364309103,  359038363757632693,
      478550329481184282,  1049521739505376845, 342041124289036843,
      411069438039718406,  22628400045285278,   1035191475784527985,
      831782706757706552,  487453762382860250,  804371142806878602,
      773458093316079330,  1027936816774104436, 839254936202710642,
      612276344795755026,  1083421134917590836, 503119453833842067,
      772682426217147534,  4648513294051462,    1001925510027124726,
      810153912390908132,  686872462847237325,  952208578492087579,
      99317068700144289,   216399813008826411,  990262526754645239,
      1018442251426773585, 1122765374191248196, 887468626354871886,
      611351699023600219,  176523832850344599,  874604855921611366,
      930771526093724666,  384225738678687662,  310609443206210283,
      978563765015693392,  146448602566418895,  1010541184320236223,
      970830807042146962,  767404308089247417,  118792092384268060,
      584069432105336186,  515183950749368263,  25448741574098754,
      21057412606113516,   999111305617794392,  1129749976994699347,
      688622945856924731,  996780068595000113,  730461537684105034,
      703839952849350240,  836189960074615569,  9965786368290302,
      1022753128183315132, 457791412277280185,  838699357509094376,
      669352748867745087,  777640615236113347,  515491998086958586,
      22337675032588295,   921276574097071548,  276893475157683905,
      222765140019507906,  189085697679030787,  485969499083307178,
      394052608262137372,  354983864593933029,  650739853260372299,
      150925363689146454,  860033267276834205,  64158107632500233,
      320226683055286032,  87192011525625259,   981784934467875409,
      527071537320703673,  965696431832879478,  270895121400502807,
      983638898027736718,  899860554643459370,  980532978639766978,
      838606151544943887,  643575449448610307,  260149458260528068,
      188670749817865194,  408526948039545739,  483363676893191376,
      141525418164796335,  251841234747227918,  92979910266281268,
      104068101650464168,  293734723701040459,  436954268041306073,
      893531533644907733,  200792843161699102,  957179650762024354,
      863442023893262303,  1140413509567458574, 435670479665087428,
      1115271598003878544, 778609289742573301,  667730159112165294,
      414503306462674705,  864245127275005275,  170057005504807874,
      131367665319549027,  942006794550612247,  504545381580628144,
      920026650661790056,  53020289128737818,   510799856957429509,
      668920664284484513,  914439720459742648,  559483155526438679,
      835699593117872358,  952564060292247722,  443723619586912482,
      66598615081947312,   583375071340718697,  884363805560047411,
      161385996910400600,  376134121320942220,  409468597598633996,
      569579765642904161};

  CkksSwitchKey(input.data(), t_target_iter_ptr.data(), coeff_count,
                decomp_modulus_size, key_modulus_size, rns_modulus_size,
                key_component_count, moduli.data(), hexl_key_vectors.data(),
                modswitch_factors.data());

  std::vector<uint64_t> expected_output{
      495623558305399188,  214844834305871787,  596312404856449861,
      487275160171237020,  36515369079533926,   165861524955059192,
      522524426449380282,  230316737919595425,  405132211644292513,
      1030957564765114902, 834393015933900986,  594286024836562826,
      607089470226340855,  769083674506920872,  819729663202086794,
      1050921533617071506, 431472277879260313,  537201912882502612,
      565553315913689103,  601687408405505672,  408712154264466850,
      90740894721546591,   556874744570695624,  830754850124859782,
      320453464580428063,  593401574993448452,  732891687918284657,
      371809593530162983,  1001454525366675852, 732780043029724,
      202815603844093166,  454198746008592263,  605075762207537107,
      572556920153639700,  334467929831739521,  486154142881643467,
      116621528877889392,  51816316975464780,   924341204502957791,
      1006292943685855593, 694086567339315767,  133328698580409382,
      346669433842479742,  965187047168586265,  264356173651892682,
      1139023745638779333, 141917252182577271,  101368482075742431,
      474479072033083881,  736329199261698924,  374792759734606645,
      1122805577652694093, 501848951528712861,  565880010210006232,
      1075914176987415038, 332611023748384479,  16968992677920566,
      94803429051531115,   1076047138759934707, 638219282519278943,
      113553726715233854,  718152050203025311,  28688847429354111,
      895233197826208523,  1151621081486746424, 342768168786380992,
      297171380632140589,  1080652918214255830, 640711213560831547,
      23408151205421384,   47810660628238585,   897270172882153247,
      258294333370785400,  404305198839813483,  951808766999264920,
      1042036099256408159, 21193171902615077,   542029545849686990,
      734767407165136278,  97915369581997217,   461214597753847580,
      10914509249086716,   413896257216620272,  1152151725550089886,
      766126479883930101,  403010923545807605,  1082746752510691558,
      960317943729829788,  431711772893479979,  350546725067420553,
      186812693867024787,  234683343756563377,  693338176471071853,
      243750816604346500,  923818187316737645,  1040757312656221774,
      909295280879257225,  680534540206845604,  684978947582074175,
      52607181634370137,   685797867597810907,  300645843846562616,
      832205345080585850,  1128822566516953165, 404180605920256825,
      872473510385747775,  320569488098117650,  210856469664942229,
      539250971102320060,  298469551650485925,  289781908158541291,
      533595691003405041,  13494277119974708,   578332814135827505,
      504406640261128937,  880714888425986018,  381962702515107091,
      1115642121854558501, 713455555698696860,  935836708874132939,
      837437593620274362,  119303941343725532,  691811663602972770,
      365697081885133143,  595622409221184973,  734080121997509029,
      306251815704046665,  423607589264753545,  369621470664204244,
      585360412002906466,  390959008476416466,  816441361572626544,
      23898957909763025,   927560476979362555,  741214488048971780,
      38275442229872910,   1134548864035216227, 534187383885217506,
      558184611284892177,  228288634240658147,  857557585893596169,
      660127267056071826,  765527948668622174,  1086553553886745209,
      104703717634719551,  294982808330659650,  1062605373510130264,
      310919175785725472,  420802228516606807,  1120599667810241448,
      708094062955587391,  94709983218672156,   999390905146225579,
      780995135444009965,  731038697543186142,  464667201319937171,
      589121716488464276,  666446783453038736,  511284162902740724,
      222686004927567651,  369951010819577612,  1121269648934323613,
      609883978730478367,  201457707127937738,  968390971416816592,
      525500944889968509,  626245159431424456,  811060832787719007,
      168913653190930967,  261905381609239656,  276899484269795575,
      62614722649577979,   542484440107367391,  256030129563409128,
      1128866840730787741, 736729978747308391,  925133655979497412,
      1011346397861647225, 185605572464395472,  1010508210396938338,
      924211481985591121,  278993245498918533,  1072440532412386301,
      440040887268973166,  64508434060327971,   970759970727775938,
      1020731891925182229, 720319139280614392,  250743736618716146,
      1014968739031549296, 227231427227916899,  289263258045811377,
      692664545334866929,  1124614939412248744, 316913689906778336,
      502751451637584273,  448374438162847197,  1030701431396478580,
      75489129065922755,   286255534507041355,  444402504238484665,
      1088748604276045962, 939860002673491013,  359682026825819724,
      677138593633626059,  408665307039865292,  822306248758053802,
      706633551060734131,  311188737454608635,  22120379678596224,
      868246843173539195,  453085702393549968,  575641884661294232,
      374466555498054871,  1005781395776238152, 862908858470255428,
      242177490649854353,  1056545414283659351, 946325740106188139,
      806353382644432195,  138654860097695945,  182129121846879922,
      1093184841741787047, 335840411436580746,  802181971656843338,
      43739374567588163,   1063485984037820706, 564749997921278722,
      534635788208823940,  206500818157819278,  639786015001809305,
      487897142381259403,  718212841973207034,  624190142829854960,
      1026038444234873390, 794607050132569490,  444086435392296992,
      156992770632837419,  896576834278850575,  151250070890896568,
      290226571640660861,  438617960756316519,  362439810868771493,
      629770666953856572,  755057168074961008,  207771837685764235,
      156414154154188425,  676192868140059676,  366101279894594798,
      696985604105939682,  64389763462575915,   572323283290212535,
      88207203866235362,   767646101877628728,  540529493395828733,
      510416251813794158};

  AssertEqual(input, expected_output);
}

}  // namespace hexl
}  // namespace intel
